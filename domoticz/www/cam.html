<div id="cameracontent">
</div>
<div id="cameramain" style="display:none;">
    <table class="display" id="cameratable" border="0" cellpadding="0" cellspacing="0" width="100%">
        <thead>
            <tr valign="middle">
                <th width="70" align="left">Preview</th>
                <th align="left">Name</th>
                <th width="48" align="left"></th>
                <th width="60" align="left">Enabled</th>
                <th width="100" align="left">Address</th>
                <th width="80" align="center">Port</th>
                <th width="80" align="center">VideoURL</th>
                <th width="80" align="center">ImageURL</th>
            </tr>
        </thead>
    </table>
    <table id="updelclr" border="0" cellpadding="0" cellspacing="0" width="100%">
			<tr>
				<td>
					<a class="btnstyle3-dis" id="cameraupdate" >Update</a>&nbsp;&nbsp;&nbsp;
					<a class="btnstyle3-dis" id="cameradelete" >Delete</a>
				</td>
			</tr>
		</table>
		<br>
		<table class="display" id="cameraparamstable" border="0" cellpadding="0" cellspacing="20">
			<tr>
				<td align="right" style="width:80px"><label for="enabled">Enabled:</label></td>
				<td><input type="checkbox" id="enabled" checked></td>
			</tr>
			<tr>
				<td align="right" style="width:110px"><label for="cameraname">Name:</label></td>
				<td><input type="text" id="cameraname" style="width: 250px; padding: .2em;" class="text ui-widget-content ui-corner-all" /></td>
			</tr>
			<tr>
				<td align="right" style="width:110px"><label for="cameraaddress">IP Address:</label></td>
				<td><input type="text" id="cameraaddress" style="width: 200px; padding: .2em;" class="text ui-widget-content ui-corner-all" /></td>
			</tr>
			<tr>
				<td align="right" style="width:110px"><label for="cameraport">Port:</label></td>
				<td><input type="text" id="cameraport" style="width: 60px; padding: .2em;" class="text ui-widget-content ui-corner-all" /></td>
			</tr>
			<tr>
				<td align="right" style="width:110px"><label id="lblusername" for="username">Username:</label></td>
				<td><input type="text" id="username" style="width: 150px; padding: .2em;" class="text ui-widget-content ui-corner-all" />
			</tr>
			<tr>
				<td align="right" style="width:110px"><label id="lblpassword" for="password">Password:</label></td>
					<td><input type="password" id="password" style="width: 150px; padding: .2em;" class="text ui-widget-content ui-corner-all" />
			</tr>
			<tr>
				<td align="right" style="width:110px"><label for="videourl">VideoURL:</label></td>
				<td><input type="text" id="videourl" style="width: 130px; padding: .2em;" class="text ui-widget-content ui-corner-all" /></td>
			</tr>
			<tr>
				<td align="right" style="width:110px"><label for="imageurl">ImageURL:</label></td>
				<td><input type="text" id="imageurl" style="width: 130px; padding: .2em;" class="text ui-widget-content ui-corner-all" /></td>
			</tr>
			</table>
		<br>
    <a class="btnstyle3" onclick="TestCamFeed();">Test Feed</a> <a class="btnstyle3" onclick="Addcamera();">Add</a>
		<br>
		<br>
		<h2>Camera Feed:</h2>
		<br>
    <img id="camfeed" src="" style="max-width: 640px;" width="100%">
    <br>
    When everything is filled in correctly, the feed should display above.<br>Does not work in IE10.
</div>

<script type="text/javascript" charset="utf-8">

function Deletecamera(idx)
{
	var bValid = false;
	bValid=(confirm("Are you sure you want to delete this camera?")==true);
	if (bValid == false) {
		return;
	}
	$.ajax({
		 url: "json.htm?type=command&param=deletecamera&idx=" + idx,
		 async: false, 
		 dataType: 'json',
		 success: function(data) {
			RefreshcameraTable();
		 },
		 error: function(){
				HideNotify();
				ShowNotify('Problem deleting camera!', 2500, true);
		 }     
	});
}

function GetCameraSettings()
{
	var csettings = {};

	csettings.name=$("#cameracontent #cameraparamstable #cameraname").val();
	if (csettings.name=="")
	{
		ShowNotify('Please enter a Name!', 2500, true);
		return;
	}
	
	csettings.bEnabled=$('#cameracontent #cameraparamstable #enabled').is(":checked");
	
	csettings.address=$("#cameracontent #cameraparamstable #cameraaddress").val();
	if (csettings.address=="")
	{
		ShowNotify('Please enter an address!', 2500, true);
		return;
	}
	csettings.port=$("#cameracontent #cameraparamstable #cameraport").val();
	if (csettings.port!="")
	{
		var intRegex = /^\d+$/;
		if(!intRegex.test(csettings.port)) {
			ShowNotify('Please enter a valid Port!', 2500, true);
			return;
		}
	}
	else {
		csettings.port=80;
	}
	csettings.username=$('#cameracontent #cameraparamstable #username').val();
	csettings.password=$('#cameracontent #cameraparamstable #password').val();
	
	csettings.videourl=$('#cameracontent #cameraparamstable #videourl').val();
	csettings.imageurl=$('#cameracontent #cameraparamstable #imageurl').val();

	if ((csettings.videourl=="")&&(csettings.imageurl!="")) {
			ShowNotify('Please enter a Video/Image url!', 2500, true);
			return;
	}

	return csettings;
}

function TestCamFeed()
{
	var csettings=GetCameraSettings();
	if (typeof csettings == 'undefined') {
		return;
	}
	var feedsrc=GenerateCamFeedURL(csettings.address,csettings.port,csettings.username,csettings.password,csettings.videourl);
	$('#cameracontent #camfeed').attr("src", feedsrc);
}

function Updatecamera(idx)
{
	var csettings=GetCameraSettings();
	if (typeof csettings == 'undefined') {
		return;
	}

	$.ajax({
		 url: "json.htm?type=command&param=updatecamera&address=" + csettings.address + 
					"&port=" + csettings.port + "&name=" + csettings.name + "&enabled=" + csettings.bEnabled + "&idx=" + idx + 
					"&username=" + csettings.username + "&password=" + csettings.password +
					"&videourl=" + csettings.videourl + "&imageurl=" + csettings.imageurl,
		 async: false, 
		 dataType: 'json',
		 success: function(data) {
			RefreshcameraTable();
		 },
		 error: function(){
			ShowNotify('Problem updating camera settings!', 2500, true);
		 }     
	});
}

function Addcamera()
{
	var csettings=GetCameraSettings();
	if (typeof csettings == 'undefined') {
		return;
	}

	$.ajax({
		 url: "json.htm?type=command&param=addcamera&address=" + csettings.address +
					"&port=" + csettings.port + "&name=" + csettings.name + "&enabled=" + csettings.bEnabled +
					"&username=" + csettings.username + "&password=" + csettings.password +
					"&videourl=" + csettings.videourl + "&imageurl=" + csettings.imageurl,
		 async: false, 
		 dataType: 'json',
		 success: function(data) {
			RefreshcameraTable();
		 },
		 error: function(){
			ShowNotify('Problem adding camera!', 2500, true);
		 }     
	});		
}

function GetCameraSnapshot(idx)
{
	window.location = "camsnapshot.jpg?idx=" + idx;
}

function RefreshcameraTable()
{
  $('#modal').show();

	$('#updelclr #cameraupdate').attr("class", "btnstyle3-dis");
	$('#updelclr #cameradelete').attr("class", "btnstyle3-dis");

  var oTable = $('#cameratable').dataTable();
  oTable.fnClearTable();
  $.ajax({
     url: "json.htm?type=cameras", 
     async: false, 
     dataType: 'json',
     success: function(data) {
        
      if (typeof data.result != 'undefined') {
        $.each(data.result, function(i,item){
			var enabledstr="No";
			if (item.Enabled=="true") {
				enabledstr="Yes";
			}

			var previewimg;
			if (item.Enabled=="true") {
				var imgsrc=GenerateCamImageURL(item.Address,item.Port,item.Username,item.Password,item.ImageURL);
				previewimg='<img src="' + imgsrc + '" height="40"> ';
			}
			else {
				previewimg='<img src="" height="40"> ';
			}
			
			var captureimg='<img  src="images/capture.png" title="Take Snapshot" height="32">';
			captureurl="<a href=\"camsnapshot.jpg?idx=" + item.idx + "\">" + captureimg + "</a>";
			
			var addId = oTable.fnAddData( {
				"DT_RowId": item.idx,
				"Name": item.Name,
				"Address": item.Address,
				"Username": item.Username,
				"Password": item.Password,
				"VideoURL": item.VideoURL,
				"ImageURL": item.ImageURL,
				"Enabled": item.Enabled,
				"IntPort": item.Port,
				"0": previewimg,
				"1": item.Name,
				"2": captureurl,
				"3": enabledstr,
				"4": item.Address,
				"5": item.Port,
				"6": item.VideoURL,
				"7": item.ImageURL
			} );
        });
		/* Add a click handler to the rows - this could be used as a callback */
		$("#cameratable tbody tr").click( function( e ) {
			if ( $(this).hasClass('row_selected') ) {
				$(this).removeClass('row_selected');
				$('#updelclr #cameraupdate').attr("class", "btnstyle3-dis");
				$('#updelclr #cameradelete').attr("class", "btnstyle3-dis");
				$('#cameracontent #camfeed').attr("src", "");
				$("#cameracontent #cameraparamstable #cameraname").val("");
				$("#cameracontent #cameraparamstable #cameraaddress").val("");
				$("#cameracontent #cameraparamstable #cameraport").val("");
				$('#cameracontent #cameraparamstable #enabled').prop('checked',true);
				$("#cameracontent #cameraparamstable #username").val("");
				$("#cameracontent #cameraparamstable #password").val("");
				$("#cameracontent #cameraparamstable #videourl").val("mjpeg.cgi");
				$("#cameracontent #cameraparamstable #imageurl").val("image.jpg");
			}
			else {
				oTable.$('tr.row_selected').removeClass('row_selected');
				$(this).addClass('row_selected');
				$('#updelclr #cameraupdate').attr("class", "btnstyle3");
				$('#updelclr #cameradelete').attr("class", "btnstyle3");
				var anSelected = fnGetSelected( oTable );
				if ( anSelected.length !== 0 ) {
					var data = oTable.fnGetData( anSelected[0] );
					var idx= data["DT_RowId"];
					$.myglobals.SelectedTimerIdx=idx;
					$("#updelclr #cameraupdate").attr("href", "javascript:Updatecamera(" + idx + ")");
					$("#updelclr #cameradelete").attr("href", "javascript:Deletecamera(" + idx + ")");
					$("#cameracontent #cameraparamstable #cameraname").val(data["Name"]);
					$("#cameracontent #cameraparamstable #cameraaddress").val(data["Address"]);
					$("#cameracontent #cameraparamstable #cameraport").val(data["IntPort"]);
					$('#cameracontent #cameraparamstable #enabled').prop('checked',(data["Enabled"]=="true"));
					$("#cameracontent #cameraparamstable #username").val(data["Username"]);
					$("#cameracontent #cameraparamstable #password").val(data["Password"]);
					$("#cameracontent #cameraparamstable #videourl").val(data["VideoURL"]);
					$("#cameracontent #cameraparamstable #imageurl").val(data["ImageURL"]);
					if (data["Enabled"]=="true") {
						var feedsrc=GenerateCamFeedURL(data["Address"],data["IntPort"],data["Username"],data["Password"],data["VideoURL"]);
						$('#cameracontent #camfeed').attr("src", feedsrc);
					}
					else {
						$('#cameracontent #camfeed').attr("src", "");
					}
				}
			}
		}); 
      }
     }
  });
  $('#modal').hide();
}


function Showcameras()
{
	var oTable;
	
	$('#modal').show();
	var htmlcontent = "";
	htmlcontent+=$('#cameramain').html();
	$('#cameracontent').html(htmlcontent);
	$("#cameracontent #cameraparamstable #videourl").val("mjpeg.cgi");
	$("#cameracontent #cameraparamstable #imageurl").val("image.jpg");
	oTable = $('#cameratable').dataTable( {
		"sDom": '<"H"lfrC>t<"F"ip>',
		"oTableTools": {
		"sRowSelect": "single",
		},
		"aoColumnDefs": [
			{ "bSortable": false, "aTargets": [ 0,2 ] }
		],
		"aaSorting": [[ 1, "asc" ]],
		"bSortClasses": false,
		"bProcessing": true,
		"bStateSave": true,
		"bJQueryUI": true,
		"aLengthMenu": [[25, 50, 100, -1], [25, 50, 100, "All"]],
		"iDisplayLength" : 25,
		"sPaginationType": "full_numbers"
		} );

	$('#modal').hide();
	RefreshcameraTable();
 }


$(document).ready(function() {
  Showcameras();
} );  
</script>
