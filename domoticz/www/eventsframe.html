<html>
  <head>
    <meta charset="utf-8">
    <script type="text/javascript" src="js/blockly_compressed.js"></script>
    <script type="text/javascript" src="js/en_compressed.js"></script>
    <script type="text/javascript" src="js/jquery-1.9.1.min.js"></script>
    <scrip  type="text/javascript" src="js/jquery-ui-1.10.1.custom.min.js"></script>
	<script type="text/javascript" src="js/noty/jquery.noty.js"></script>
    <script type="text/javascript" src="js/noty/layouts/top.js"></script>
    <script type="text/javascript" src="js/noty/layouts/topRight.js"></script>
    <script type="text/javascript" src="js/noty/themes/default.js"></script>
    <script type="text/javascript" charset="utf-8" src="js/domoticz.js"></script>
    <script type="text/javascript" src="js/domoticzblocks.js"></script>
    <link rel="stylesheet" href="css/bootstrap.css">
    <link href="css/bootstrap-responsive.css" rel="stylesheet" media="screen">
    <link type="text/css" rel="stylesheet" href="css/ui-darkness/jquery-ui-1.10.1.custom.min.css" />
    <link type="text/css" rel="stylesheet" href="css/style.css" />	
	    
    <style>
      html, body {
        background-color: transparent;
        margin: 0;
        padding: 0;
        overflow: hidden;
      }
      .blocklySvg {
        height:100%;
        width: 100%; 
      }
      .blocklyTreeRow {
        color:black;
      }
      #saveTable
      { border-spacing: 8px;
    	padding:2px 2px 2px 2px;
      }
    </style>
    <script>
	  
      function init() {
      	Blockly.inject(document.getElementById('blocklyDiv'),
        {path: './', toolbox: document.getElementById('toolbox')});
        //Blockly.inject(document.body,
          //  {path: '../../', toolbox: document.getElementById('toolbox')});
        // Let the top-level application know that Blockly is ready.
        window.parent.blocklyLoaded(Blockly);
        load_blocks();
      }
      
      function opSymbol(operand) {
	     switch(operand)
		{
		case 'EQ':
		  operand = ' == ';
		  break;
		case 'NEQ':
		  operand = ' ~= ';
		  break;
		case 'LT':
		  operand = ' < ';
		  break;
		case 'GT':
		  operand = ' > ';
		  break;
		case 'LTE':
		  operand = ' <= ';
		  break;
		case 'GTE':
		  operand = ' >= ';
		  break;
		default:
		} 
		return operand;		     
      }
      
      function parseXml(xml) {
      	
      	var boolString = "";
     
		function parseLogicCompare(thisBlock){
			var locOperand = opSymbol($($(thisBlock).children("title:first")).text());
			var valueA = $(thisBlock).children("value[name='A']")[0];
			var variableType = $(valueA).children("block:first").attr("type");
			if (variableType == "switchvariables") {
				var titleA = $(valueA).find("title")[0];
				var valueB = $(thisBlock).children("value[name='B']")[0];
				var titleB = $(valueB).find("title")[0];
				var compareString = "device["+$(titleA).text()+"]";
				if ($(titleB).attr("name") == "State") {
					compareString += locOperand;
					compareString += '"'+$(titleB).text()+'"'; 
				}
				return compareString;
			}
			else if (variableType == "temperaturevariables") {
				var titleA = $(valueA).find("title")[0];
				var valueB = $(thisBlock).children("value[name='B']")[0];
				var titleB = $(valueB).find("title")[0];
				var compareString = "temperaturedevice["+$(titleA).text()+"]";
				if ($(titleB).attr("name") == "NUM") {
					compareString += locOperand;
					compareString += '"'+$(titleB).text()+'"'; 
				}
				return compareString;						
			}
			else if (variableType == "humidityvariables") {
				var titleA = $(valueA).find("title")[0];
				var valueB = $(thisBlock).children("value[name='B']")[0];
				var titleB = $(valueB).find("title")[0];
				var compareString = "humiditydevice["+$(titleA).text()+"]";
				if ($(titleB).attr("name") == "NUM") {
					compareString += locOperand;
					compareString += '"'+$(titleB).text()+'"'; 
				}
				return compareString;						
			}
			else if (variableType == "barometervariables") {
				var titleA = $(valueA).find("title")[0];
				var valueB = $(thisBlock).children("value[name='B']")[0];
				var titleB = $(valueB).find("title")[0];
				var compareString = "barometerdevice["+$(titleA).text()+"]";
				if ($(titleB).attr("name") == "NUM") {
					compareString += locOperand;
					compareString += '"'+$(titleB).text()+'"'; 
				}
				return compareString;						
			}
			else {
				return "unknown comparevariable "+variableType;
			}
		}
		
		function parseLogicTimeOfDay(thisBlock) {
				var locOperand = opSymbol($($(thisBlock).children("title:first")).text());
				var valueA = $(thisBlock).children("title[name='Time']")[0];				
				var hours=parseInt($(valueA).text().substr(0,2));
				var minutes=parseInt($(valueA).text().substr(3,2));
				var totalminutes=(hours*60)+minutes;
				//var hoursNoColon = $(valueA).text().replace(/\:/g, '');
				var compareString = 'timeofday '+locOperand+' '+totalminutes;
			  	return compareString;		
		}
		
		function parseLogicWeekday(thisBlock) {
				var locOperand = opSymbol($($(thisBlock).children("title:first")).text());
				var valueA = $(thisBlock).children("title[name='Weekday']")[0];
				var compareString = 'weekday '+locOperand+' '+$(valueA).text(); 
			  	return compareString;
		}		
		
		function parseValueBlock(thisBlock,locOperand,Sequence) {
			var firstBlock = $(thisBlock).children("block:first");
			if (firstBlock.attr("type")=="logic_compare") {
				var compareString = parseLogicCompare(firstBlock);
			  	return compareString;
			}
			else if (firstBlock.attr("type")=="logic_weekday") {
				conditionstring = parseLogicWeekday(firstBlock);
				return conditionstring;
			}
			else if (firstBlock.attr("type")=="logic_timeofday") {
				conditionstring = parseLogicTimeOfDay(firstBlock);
				return conditionstring;
			}
			else if (firstBlock.attr("type")=="logic_operation") {
				parseLogicOperation(firstBlock);
			}
		}
		
    	function parseLogicOperation(thisBlock){
    		var locOperand = ' '+$($(thisBlock).children("title:first")).text().toLowerCase()+' ';
			var valueA = $(thisBlock).children("value[name='A']")[0];
			var valueB = $(thisBlock).children("value[name='B']")[0];
			conditionA = parseValueBlock(valueA,locOperand,"A");
			conditionB = parseValueBlock(valueB,locOperand,"B");
			var conditionstring = "("+conditionA+" "+locOperand+" "+conditionB+")";
			
			if((conditionA!=undefined)&&(conditionB!=undefined)) {
				if (boolString == "") {
					{boolString += conditionstring};
				}
				else {
					{boolString += locOperand}
					{boolString += conditionstring}
				}
			} 
		}
  
      	if ($(xml).children().length > 1) {
		  	return "err:Please make sure there is only a single block structure";
		}
		var firstBlockType = $(xml).find("block").first().attr("type");
	    if (firstBlockType !="domoticzcontrols_if") {
			return "err:Please start with a control block";
	    }	
	    
	    
	    var ifBlock = $($(xml).find("value[name='IF0']")[0]).children('block:first');

      	if (ifBlock.attr("type")=="logic_compare") {
      		// just the one compare, easy
      		var compareString = parseLogicCompare(ifBlock);
      		boolString += compareString;
      	}

      	else if (ifBlock.attr("type")=="logic_operation") {
      		// nested logic operation, drill down
      		parseLogicOperation(ifBlock);
    
      	}
      	else if (ifBlock.attr("type")=="logic_timeofday") {
      		// nested logic operation, drill down
      		var compareString = parseLogicTimeOfDay(ifBlock);
      		boolString += compareString;
      	}
      	else if (ifBlock.attr("type")=="logic_weekday") {
      		// nested logic operation, drill down
      		var compareString = parseLogicWeekday(ifBlock);
      		boolString += compareString;
      	}

      	
      	var setArray = [];
      	var doBlock = $($(xml).find("statement[name='DO0']")[0]);
 	      $(doBlock).find('block').each (function(){ 
	      	if ($(this).attr('type') == 'logic_set') {
		   		var valueA = $(this).find("value[name='A']")[0];
	        	var titleA = $(valueA).find("title")[0];
	        	var valueB = $(this).find("value[name='B']")[0];
	        	var titleB = $(valueB).find("title")[0];
	        	var setString = "commandArray["+$(titleA).text()+"]";
	        	if ($(titleB).attr("name") == "State") {
	        		setString += '="'+$(titleB).text()+'"'; 
	        	}
	        	setArray.push(setString);
		    }
	      	if ($(this).attr('type') == 'logic_setdelayed') {
		   		var valueA = $(this).find("value[name='A']")[0];
	        	var titleA = $(valueA).find("title")[0];
	        	var valueB = $(this).find("value[name='B']")[0];
	        	var titleB = $(valueB).find("title")[0];
	        	var valueC = $(this).find("value[name='C']")[0];
	        	var titleC = $(valueC).find("title")[0];
	        	var setString = "commandArray["+$(titleA).text()+"]";
	        	if ($(titleB).attr("name") == "State") {
	        		setString += '="'+$(titleB).text()+' FOR '+ $(titleC).text()+'"'; 
	        	}
	        	setArray.push(setString);
		    }
		    else if ($(this).attr('type') == 'send_notification') {
		    	var subjectBlock = $(this).find("value[name='notificationTextSubject']")[0];
		    	var bodyBlock = $(this).find("value[name='notificationTextBody']")[0];
		    	var sTitleText = $(subjectBlock).find("title[name='TEXT']")[0];
		    	var bTitleText = $(bodyBlock).find("title[name='TEXT']")[0];
		    	var sTT = $(sTitleText).text().replace(/\,/g, ' ');
		    	var bTT = $(bTitleText).text().replace(/\,/g, ' ');
		    	// message separator here cannot be # like in scripts, changed to $..
		    	// also removed commas as we need to separate commandArray later.
	        	var setString = 'commandArray["SendNotification"]="'+sTT+'$'+bTT+'"';
	        	setArray.push(setString);		      	
		    }
		  });
		  var conditionArray = [];
		  conditionArray.push(boolString);
	      return [conditionArray,setArray];     
      }
      
      function loadSelectedEvent(id) {
      		$.ajax({
			  	url: "json.htm?type=events&param=load&event="+id, 
			  	async: false, 
			  	dataType: 'json',
			  	success: function(data) {
				  	if (typeof data.result != 'undefined') {
				  		if (data.status=="OK") {
					  		var xml = Blockly.Xml.textToDom(data.result[0].xmlstatement);
					  		Blockly.mainWorkspace.clear();
					  		Blockly.Xml.domToWorkspace( Blockly.mainWorkspace, xml );
					  		$("#blockName").val(data.result[0].name);
					  		$("#blockId").html(id);

				  		}
				  		else { alert("Error loading event!");}
					}
				}
			});

	  }
	  
      function delete_block() {
        var id = document.getElementById("savedEvents").value;
        if (id!=null) {
	        $.ajax({
			  	url: "json.htm?type=events&param=delete&event="+id, 
			  	async: false, 
			  	dataType: 'json',
			  	success: function(data) {
				  	if (typeof data != 'undefined') {
				  		if (data.status=="OK") {
				  			generate_noty('alert', '<b>Event Deleted<br>'+$("#blockName").val(), 2000);
				  			Blockly.mainWorkspace.clear();
					  		$("#blockName").val("");
				  			load_blocks();
				  		}
					}
				}
			  });
		}
        else {alert("Nothing selected!")}
	  }
	  
	  	  
	  function load_blocks() {
		  var select = document.getElementById("savedEvents");
		  select.options.length = 0;
		  $.ajax({
		  	url: "json.htm?type=events&param=list", 
		  	async: false, 
		  	dataType: 'json',
		  	success: function(data) {
			  	if (typeof data.result != 'undefined') {
				  	$.each(data.result, function(i,item){
						var option = document.createElement("option");
						option.text = item.name;
						option.value = item.id;
						select.appendChild(option);
					});
				}
			}
		  });
	  }
	  function new_block() {
	  	$("#blockName").val("");
	  	$("#blockId").html("");
	  	Blockly.mainWorkspace.clear();
	  	$("#savedEvents").val("");
	  }
      
      function save_block() {
      	var xml = Blockly.Xml.workspaceToDom( Blockly.mainWorkspace );
      	//$("#blockDebug").html(Blockly.Xml.domToPrettyText(xml));
      	var blockName = $("#blockName").val();
      	var id = "";
      	if (blockName) { 
      		var exists = false; 
      		var doSave = false;
      		$('#savedEvents  option').each(function(){
	      		if (this.text == blockName) {
		      		exists = true;
		      	}
		     });
		     if (exists) {
			 	var answer = confirm("Overwrite "+blockName+"?")
			    if (answer){
					doSave = true;
					id = $("#blockId").html();
				}
				else{
					doSave = false;
				}
			}
			else {doSave = true;}
      		if (doSave) {
      		   var blockXml  = Blockly.Xml.domToText( xml );
      		   var blockXmlTranslated = parseXml(xml);
      		   if (typeof(blockXmlTranslated)=='string') {
      		   	var answerparts = blockXmlTranslated.split(':');
      		   	if (answerparts[0]=="err") {
      		   		alert(answerparts[1]);
      		   	}
      		   }
      		   else if (typeof(blockXmlTranslated)=='object') {
      	    		var conditions = blockXmlTranslated[0];
      	    		var actions = blockXmlTranslated[1];
      	    		$.ajax({
	      	    		url : "json.htm?type=events&param=create&name="+blockName+"&xml="+blockXml+"&conditions="+conditions+"&actions="+actions+"&eventid="+id, 
	      	    		async: false, 
	      	    		dataType: 'json',
	      	    		success: function(data) {
		      	    		if (typeof data != 'undefined') {
				  				if (data.status=="OK") {
				  					generate_noty('information', '<b>Event saved:<br>'+blockName, 2000);
				  					load_blocks();
				  				}
				  			}
				  		}
				  	});
			  } 	    
			}
			else {alert("Save aborted!")}
		}
      	else {alert('no event name entered!');}
      }

	$(window).resize(function() {
		ResizeBlockyWindow();
	});


	function ResizeBlockyWindow()
	{
		$("#blocklyDiv").css("width", $(window).width()-250);
		$("#blocklyDiv").css("height", $(window).height()-20);
	}

	$(document).ready(function() 
	{
		ResizeBlockyWindow();
		//return;
		$("#toolbox").css("font-color", "black");
	});
      
    </script>

  </head>
  <body onload="init()">
    <xml id="toolbox" style="display: none">
   		<category name="Control">
	   		<block type="domoticzcontrols_if"></block>
   		</category>
   		<category name="Logic">
	   		<block type="logic_compare"></block>
	   		<block type="logic_operation"></block>
	   		<!--<block type="logic_boolean"></block>-->
	   		<block type="logic_states"></block>
	   		<block type="logic_set"></block>
	   		<block type="logic_setdelayed"></block>
	   		<block type="logic_timeofday"></block>
	   		<block type="logic_weekday"></block>
	   		<block type="math_number"></block>
   		</category>
   		<category name="Messages">
   			<block type="send_notification"></block>
   			<block type="text"></block>
   		</category>
   		<category name="Devices">   		
		   	<category name="Switches">
			   	<block type="switchvariables"></block>
			</category>   		
		   	<category name="Temperature">
			   	<block type="temperaturevariables"></block>
		   	</category>	   		   		
		   	<category name="Humidity">
			   	<block type="humidityvariables"></block>
		   	</category>	
		   	<category name="Barometer">
			   	<block type="barometervariables"></block>
		   	</category>	
		   	<category name="Weather">
			   	<block type="weathervariables"></block>
		   	</category>
		   	<category name="Utility">
			   	<block type="utilityvariables"></block>
		   	</category>
		   	<category name="Scenes">
			   	<block type="scenevariables"></block>
		   	</category>
   		</category>	
    </xml>
    <div id="maindiv" class="container-fluid">
		<div class="row-fluid">
			<table id="saveTable" border="0" cellpadding="0" cellspacing="0" width="100%">
			<tr>
				<td valign="top">
					<div id="blocklyDiv"></div>
				</td>
				<td style="width:200px" valign="top">
					<label for="blockName">Event name: </label><br>
					<input type="input" id="blockName" name="blockName" style="width: 12em; padding: .2em;" class="text ui-widget-content ui-corner-all" />
					<br/>
					<a class="btnstyle3" href="javascript:save_block()">Save</a>
					<a class="btnstyle3" href="javascript:new_block()">New</a>
					<P>
					<label for="savedEvents">Saved events: </label><br>
					<select size="10" width="100%" style="width: 100%" id="savedEvents" name="savedEvents" onchange="loadSelectedEvent(this.value);">> 
					</select>
					<br/><a class="btnstyle3" href="javascript:delete_block()">Delete selected</a>
					<!--<br/><textarea id="blockDebug" width="100em" height="100em"></textarea>-->
					<br/><div id="blockId" style="display:none;"/>
					
				</td>
			</tr>
			</table>
		</div>
	</div>
  </body>
</html>