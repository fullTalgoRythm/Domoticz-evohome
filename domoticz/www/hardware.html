<div id="hardwarecontent">
</div>
<div id="hardwaremain" style="display:none;">
    <table class="display" id="hardwaretable" border="0" cellpadding="0" cellspacing="0" width="100%">
        <thead>
            <tr>
                <th width="120" align="left">Name</th>
                <th width="60" align="left">Enabled</th>
                <th width="60" align="left">Shared</th>
                <th width="240" align="left">Type</th>
                <th width="200" align="left">Address</th>
                <th width="80" align="center">Port</th>
            </tr>
        </thead>
    </table>
    <table id="updelclr" border="0" cellpadding="0" cellspacing="0" width="100%">
			<tr>
				<td>
					<a class="btnstyle3-dis" id="hardwareupdate" >Update</a>&nbsp;&nbsp;&nbsp;
					<a class="btnstyle3-dis" id="hardwaredelete" >Delete</a>
				</td>
			</tr>
		</table>
		<br>
		<table class="display" id="hardwareparamstable" border="0" cellpadding="0" cellspacing="20">
			<tr>
				<td align="right" style="width:80px"><label for="enabled">Enabled:</label></td>
				<td><input type="checkbox" id="enabled" checked></td>
			</tr>
			<tr>
				<td align="right" style="width:110px"><label for="name">Name:</label></td>
				<td><input type="text" id="hardwarename" style="width: 250px; padding: .4em;" class="text ui-widget-content ui-corner-all" /></td>
			</tr>
			<tr>
				<td align="right" style="width:110px"><label for="name">Type:</label></td>
				<td><select id="combotype" style="width:410px" class="combobox ui-corner-all">
						<!--#embed hardwaretypes -->
						</select>
				</td>
			</tr>
		</table>
		<div id="divserial">
			<br>
			<table class="display" id="hardwareparamsserial" border="0" cellpadding="0" cellspacing="20">
				<tr>
					<td align="right" style="width:110px"><label id="lblserialport" for="name">Serial Port:</label></td>
					<td><select id="comboserialport" style="width:210px" class="combobox ui-corner-all">
							<!--#embed serialdevices -->
							</select>
					</td>
				</tr>
			</table>
		</div>
		<div id="divremote">
			<br>
			<table class="display" id="hardwareparamsremote" border="0" cellpadding="0" cellspacing="20">
				<tr>
					<td align="right" style="width:110px"><label id="lblremoteaddress" for="name">Remote Address:</label></td>
					<td><input type="text" id="tcpaddress" style="width: 250px; padding: .4em;" class="text ui-widget-content ui-corner-all" /></td>
				</tr>
				<tr>
					<td align="right" style="width:110px"><label id="lblremoteport" for="name">port:</label></td>
					<td><input type="text" id="tcpport" style="width: 50px; padding: .4em;" class="text ui-widget-content ui-corner-all" /></td>
				</tr>
			</table>
		</div>
		<div id="divlogin">
			<br>
			<table class="display" id="hardwareparamslogin" border="0" cellpadding="0" cellspacing="20">
				<tr>
					<td align="right" style="width:110px"><label id="lblusername" for="name">Username:</label></td>
					<td><input type="text" id="username" style="width: 150px; padding: .4em;" class="text ui-widget-content ui-corner-all" />
				</tr>
				<tr>
					<td align="right" style="width:110px"><label id="lblpassword" for="name">Password:</label></td>
					<td><input type="password" id="password" style="width: 150px; padding: .4em;" class="text ui-widget-content ui-corner-all" />
				</tr>
			</table>
		</div>
		<div id="divshared">
				<br>
				<table class="display" id="hardwareparamsshareenabled" border="0" cellpadding="0" cellspacing="20">
					<tr>
          <td align="right" style="width:110px"><label>Shared:</label></td>
          <td><input type="checkbox" id="shareenabled"/></td>
					</tr>
				</table>
				<div id="divsharedparam">
					<table class="display" id="hardwareparamssharedetails" border="0" cellpadding="0" cellspacing="20">
						<tr>
							<td align="right" style="width:110px"><label>Port:</label></td>
							<td><input type="text" id="shareport" style="width: 60px; padding: .4em;" class="text ui-widget-content ui-corner-all" />
						</tr>
						<tr>
							<td align="right" style="width:110px"><label>Username:</label></td>
							<td><input type="text" id="shareusername" style="width: 150px; padding: .4em;" class="text ui-widget-content ui-corner-all" />
						</tr>
						<tr>
							<td align="right" style="width:110px"><label>Password:</label></td>
							<td><input type="password" id="sharepassword" style="width: 150px; padding: .4em;" class="text ui-widget-content ui-corner-all" />
						</tr>
						<tr>
							<td align="right" style="width:110px"><label>Share:</label></td>
							<td><select id="combosharerights" style="width:230px" class="combobox ui-corner-all">
										<option value="0">Sensors</option>
										<option value="1">Sensors + Light/Switches (All !)</option>
									</select>
							</td>
						</tr>
					</table>
				</div>
		</div>
		<br>
    <a class="btnstyle3" onclick="AddHardware();">Add</a>
</div>

<script type="text/javascript" charset="utf-8">

function DeleteHardware(idx)
{
	var bValid = false;
	bValid=(confirm("Are you sure to delete this Hardware?\n\nThis action can not be undone...\nAll Devices attached will be removed!")==true);
	if (bValid == false) {
		return;
	}
	$.ajax({
		 url: "json.htm?type=command&param=deletehardware&idx=" + idx,
		 async: false, 
		 dataType: 'json',
		 success: function(data) {
			RefreshHardwareTable();
		 },
		 error: function(){
				HideNotify();
				ShowNotify('Problem deleting hardware!', 2500, true);
		 }     
	});
}

function GetSharedParameters()
{
	var shareparam="";
	var bShared=$('#hardwarecontent #hardwareparamsshareenabled #shareenabled').attr('checked')?true:false;
	shareparam+="&shared="+bShared;
	var shareport=$('#hardwarecontent #hardwareparamssharedetails #shareport').val();
	var shareusername=$('#hardwarecontent #hardwareparamssharedetails #shareusername').val();
	var sharepassword=$('#hardwarecontent #hardwareparamssharedetails #sharepassword').val();
	
	if ( (shareusername!="") && (sharepassword=="") ) {
		ShowNotify('Please enter a password!', 2500, true);
		return null;
	}
	
	var sharerights=$("#hardwarecontent #hardwareparamssharedetails #combosharerights option:selected").val();
	if (bShared==true) {
		if (shareport=="") {
			ShowNotify('Please enter Unique TCP Port for sharing!', 2500, true);
			return null;
		}
		var intPort=parseInt(shareport);
		var intRegex = /^\d+$/;
		
		if ((intPort<80)||(intPort>30000)||(!intRegex.test(shareport))) {
			ShowNotify('Please enter an Valid TCP Port for sharing!<br>Try between 80 and 30000...', 2500, true);
			return null;
		}		
	}
	
	shareparam+="&shareport="+shareport;
	shareparam+="&shareusername="+shareusername;
	shareparam+="&sharepassword="+sharepassword;
	shareparam+="&sharerights="+sharerights;
	return shareparam;
}

function UpdateHardware(idx)
{
	var name=$("#hardwarecontent #hardwareparamstable #hardwarename").val();
	if (name=="")
	{
		ShowNotify('Please enter a Name!', 2500, true);
		return;
	}

	var shareparm=GetSharedParameters();
	if (shareparm==null) {
		return;
	}

	var hardwaretype=$("#hardwarecontent #hardwareparamstable #combotype option:selected").val();
	if (typeof hardwaretype == 'undefined') {
		ShowNotify('Unknown device selected!', 2500, true);
		return;
	}
	
	var bEnabled=$('#hardwarecontent #hardwareparamstable #enabled').attr('checked')?true:false;
	
	var text = $("#hardwarecontent #hardwareparamstable #combotype option:selected").text();
	if (text.indexOf("USB") >= 0)
	{
		var serialport=$("#hardwarecontent #divserial #comboserialport option:selected").val();
		if (typeof serialport == 'undefined')
		{
			ShowNotify('No serial port selected!', 2500, true);
			return;
		}
		$.ajax({
			 url: "json.htm?type=command&param=updatehardware&htype=" + hardwaretype + "&port=" + serialport + "&name=" + name + "&enabled=" + bEnabled + "&idx=" + idx + shareparm,
			 async: false, 
			 dataType: 'json',
			 success: function(data) {
				RefreshHardwareTable();
			 },
			 error: function(){
					ShowNotify('Problem adding hardware!', 2500, true);
			 }     
		});
	}
	else if (text.indexOf("LAN") >= 0)
	{
		var address=$("#hardwarecontent #divremote #tcpaddress").val();
		if (address=="")
		{
			ShowNotify('Please enter an Address!', 2500, true);
			return;
		}
		var port=$("#hardwarecontent #divremote #tcpport").val();
		if (port=="")
		{
			ShowNotify('Please enter an Port!', 2500, true);
			return;
		}
		var intRegex = /^\d+$/;
		if(!intRegex.test(port)) {
			ShowNotify('Please enter an Valid Port!', 2500, true);
			return;
		}		
		$.ajax({
			 url: "json.htm?type=command&param=updatehardware&htype=" + hardwaretype + "&address=" + address + "&port=" + port + "&name=" + name + "&enabled=" + bEnabled + "&idx=" + idx + shareparm,
			 async: false, 
			 dataType: 'json',
			 success: function(data) {
				RefreshHardwareTable();
			 },
			 error: function(){
					ShowNotify('Problem adding hardware!', 2500, true);
			 }     
		});
	}
	else if (text.indexOf("Domoticz") >= 0)
	{
		var address=$("#hardwarecontent #divremote #tcpaddress").val();
		if (address=="")
		{
			ShowNotify('Please enter an Address!', 2500, true);
			return;
		}
		var port=$("#hardwarecontent #divremote #tcpport").val();
		if (port=="")
		{
			ShowNotify('Please enter an Port!', 2500, true);
			return;
		}
		var intRegex = /^\d+$/;
		if(!intRegex.test(port)) {
			ShowNotify('Please enter an Valid Port!', 2500, true);
			return;
		}		
		var username=$("#hardwarecontent #divlogin #username").val();
		var password=$("#hardwarecontent #divlogin #password").val();
		$.ajax({
			 url: "json.htm?type=command&param=updatehardware&htype=" + hardwaretype + "&address=" + address + "&port=" + port + "&username=" + username + "&password=" + password + "&name=" + name + "&enabled=" + bEnabled + "&idx=" + idx + shareparm,
			 async: false, 
			 dataType: 'json',
			 success: function(data) {
				RefreshHardwareTable();
			 },
			 error: function(){
					ShowNotify('Problem adding hardware!', 2500, true);
			 }     
		});
	}
}

function AddHardware()
{
	var name=$("#hardwarecontent #hardwareparamstable #hardwarename").val();
	if (name=="")
	{
		ShowNotify('Please enter a Name!', 2500, true);
		return false;
	}

	var shareparm=GetSharedParameters();
	if (shareparm==null) {
		return;
	}

	
	var hardwaretype=$("#hardwarecontent #hardwareparamstable #combotype option:selected").val();
	if (typeof hardwaretype == 'undefined') {
		ShowNotify('Unknown device selected!', 2500, true);
		return;
	}
	
	var bEnabled=$('#hardwarecontent #hardwareparamstable #enabled').attr('checked')?true:false;
	
	var text = $("#hardwarecontent #hardwareparamstable #combotype option:selected").text();
	if (text.indexOf("USB") >= 0)
	{
		var serialport=$("#hardwarecontent #divserial #comboserialport option:selected").val();
		if (typeof serialport == 'undefined')
		{
			ShowNotify('No serial port selected!', 2500, true);
			return;
		}
		$.ajax({
			 url: "json.htm?type=command&param=addhardware&htype=" + hardwaretype + "&port=" + serialport + "&name=" + name + "&enabled=" + bEnabled + shareparm,
			 async: false, 
			 dataType: 'json',
			 success: function(data) {
				RefreshHardwareTable();
			 },
			 error: function(){
					ShowNotify('Problem adding hardware!', 2500, true);
			 }     
		});
	}
	else if (text.indexOf("LAN") >= 0)
	{
		var address=$("#hardwarecontent #divremote #tcpaddress").val();
		if (address=="")
		{
			ShowNotify('Please enter an Address!', 2500, true);
			return;
		}
		var port=$("#hardwarecontent #divremote #tcpport").val();
		if (port=="")
		{
			ShowNotify('Please enter an Port!', 2500, true);
			return;
		}
		var intRegex = /^\d+$/;
		if(!intRegex.test(port)) {
			ShowNotify('Please enter an Valid Port!', 2500, true);
			return;
		}		
		$.ajax({
			 url: "json.htm?type=command&param=addhardware&htype=" + hardwaretype + "&address=" + address + "&port=" + port + "&name=" + name + "&enabled=" + bEnabled + shareparm,
			 async: false, 
			 dataType: 'json',
			 success: function(data) {
				RefreshHardwareTable();
			 },
			 error: function(){
					ShowNotify('Problem adding hardware!', 2500, true);
			 }     
		});
	}
	else if (text.indexOf("Domoticz") >= 0)
	{
		var address=$("#hardwarecontent #divremote #tcpaddress").val();
		if (address=="")
		{
			ShowNotify('Please enter an Address!', 2500, true);
			return;
		}
		var port=$("#hardwarecontent #divremote #tcpport").val();
		if (port=="")
		{
			ShowNotify('Please enter an Port!', 2500, true);
			return;
		}
		var intRegex = /^\d+$/;
		if(!intRegex.test(port)) {
			ShowNotify('Please enter an Valid Port!', 2500, true);
			return;
		}		
		var username=$("#hardwarecontent #divlogin #username").val();
		var password=$("#hardwarecontent #divlogin #password").val();
		$.ajax({
			 url: "json.htm?type=command&param=addhardware&htype=" + hardwaretype + "&address=" + address + "&port=" + port + "&username=" + username + "&password=" + password + "&name=" + name + "&enabled=" + bEnabled + shareparm,
			 async: false, 
			 dataType: 'json',
			 success: function(data) {
				RefreshHardwareTable();
			 },
			 error: function(){
					ShowNotify('Problem adding hardware!', 2500, true);
			 }     
		});
	}
}

function RefreshHardwareTable()
{
  $('#modal').show();

	$('#updelclr #hardwareupdate').attr("class", "btnstyle3-dis");
	$('#updelclr #hardwaredelete').attr("class", "btnstyle3-dis");

  var oTable = $('#hardwaretable').dataTable();
  oTable.fnClearTable();
  
  $.ajax({
     url: "json.htm?type=hardware", 
     async: false, 
     dataType: 'json',
     success: function(data) {
        
      if (typeof data.result != 'undefined') {
        $.each(data.result, function(i,item){
        
					var SerialName="Unknown!?";
					if ((item.Type == 2)||(item.Type == 3)||(item.Type == 5)||(item.Type == 6))
					{
						SerialName=item.Port;
					}
					else
					{
						var serpos=jQuery.inArray(item.Port, $.myglobals.SerialPortVal);
						if (serpos!=-1) {
							SerialName=$.myglobals.SerialPortStr[serpos];
						}
					}

					var enabledstr="No";
					if (item.Enabled=="true") {
						enabledstr="Yes";
					}
					
					var sharedstr="No";
					if (item.Shared=="true") {
						sharedstr="Yes (" + item.SharedPort + ")";
					}
					
          var addId = oTable.fnAddData( {
								"DT_RowId": item.idx,
								"Username": item.Username,
								"Password": item.Password,
								"Enabled": item.Enabled,
								"Mode1": item.Mode1,
								"Mode2": item.Mode2,
								"Mode3": item.Mode3,
								"Mode4": item.Mode4,
								"Mode5": item.Mode5,
								"IntPort": item.Port,
								"Shared": item.Shared,
								"SharedPort": item.SharedPort,
								"SharedUsername": item.SharedUsername,
								"SharedPassword": item.SharedPassword,
								"SharedRights": item.SharedRights,
                "0": item.Name,
                "1": enabledstr,
                "2": sharedstr,
								"3": $.myglobals.HardwareTypesStr[item.Type],
								"4": item.Address,
								"5": SerialName
							} );
        });
				/* Add a click handler to the rows - this could be used as a callback */
				$("#hardwaretable tbody tr").click( function( e ) {
							if ( $(this).hasClass('row_selected') ) {
									$(this).removeClass('row_selected');
									$('#updelclr #hardwareupdate').attr("class", "btnstyle3-dis");
									$('#updelclr #hardwaredelete').attr("class", "btnstyle3-dis");
							}
							else {
									oTable.$('tr.row_selected').removeClass('row_selected');
									$(this).addClass('row_selected');
									$('#updelclr #hardwareupdate').attr("class", "btnstyle3");
									$('#updelclr #hardwaredelete').attr("class", "btnstyle3");
									var anSelected = fnGetSelected( oTable );
									if ( anSelected.length !== 0 ) {
										var data = oTable.fnGetData( anSelected[0] );
										var idx= data["DT_RowId"];
										$.myglobals.SelectedTimerIdx=idx;
										$("#updelclr #hardwareupdate").attr("href", "javascript:UpdateHardware(" + idx + ")");
										$("#updelclr #hardwaredelete").attr("href", "javascript:DeleteHardware(" + idx + ")");
										$("#hardwarecontent #hardwareparamstable #hardwarename").val(data["0"]);
										$("#hardwarecontent #hardwareparamstable #combotype").val(jQuery.inArray(data["3"], $.myglobals.HardwareTypesStr));

										$('#hardwarecontent #hardwareparamstable #enabled').prop('checked',(data["Enabled"]=="true"));

										$('#hardwarecontent #hardwareparamsshareenabled #shareenabled').prop('checked',(data["Shared"]=="true"));
										$('#hardwarecontent #hardwareparamssharedetails #shareport').val(data["SharedPort"]);
										$('#hardwarecontent #hardwareparamssharedetails #shareusername').val(data["SharedUsername"]);
										$('#hardwarecontent #hardwareparamssharedetails #sharepassword').val(data["SharedPassword"]);
										$("#hardwarecontent #hardwareparamssharedetails #combosharerights").val(parseInt(data["SharedRights"]));
										
										UpdateHardwareParamControls();
										if (data["3"].indexOf("USB") >= 0)
										{
											$("#hardwarecontent #hardwareparamsserial #comboserialport").val(data["IntPort"]);
										}
										else
										if ((data["3"].indexOf("LAN") >= 0)||(data["3"].indexOf("Domoticz") >= 0))
										{
											$("#hardwarecontent #hardwareparamsremote #tcpaddress").val(data["4"]);
											$("#hardwarecontent #hardwareparamsremote #tcpport").val(data["5"]);
										}
										if (data["3"].indexOf("Domoticz") >= 0) {
											$("#hardwarecontent #hardwareparamslogin #username").val(data["Username"]);
											$("#hardwarecontent #hardwareparamslogin #password").val(data["Password"]);
										}
									}
							}
				}); 
				
      }
     }
  });
  $('#modal').hide();
}

function UpdateHardwareParamControls()
{
		var text = $("#hardwarecontent #hardwareparamstable #combotype option:selected").text();
		if (text.indexOf("USB") >= 0)
		{
			$("#hardwarecontent #divserial").show();
			$("#hardwarecontent #divremote").hide();
			$("#hardwarecontent #divlogin").hide();
		}
		else if (text.indexOf("LAN") >= 0)
		{
			$("#hardwarecontent #divserial").hide();
			$("#hardwarecontent #divremote").show();
			$("#hardwarecontent #divlogin").hide();
		}
		else if (text.indexOf("Domoticz") >= 0)
		{
			$("#hardwarecontent #divserial").hide();
			$("#hardwarecontent #divremote").show();
			$("#hardwarecontent #divlogin").show();
		}
		else
		{
			$("#hardwarecontent #divserial").hide();
			$("#hardwarecontent #divremote").hide();
			$("#hardwarecontent #divlogin").hide();
		}
		var bShared=$('#hardwarecontent #hardwareparamsshareenabled #shareenabled').attr('checked')?true:false;
		if (bShared == true) {
			$("#hardwarecontent #divsharedparam").show();
		}
		else {
			$("#hardwarecontent #divsharedparam").hide();
		}

}

function ShowHardware()
{
	var oTable;
	
	$('#modal').show();
  var htmlcontent = "";
  htmlcontent+=$('#hardwaremain').html();
  $('#hardwarecontent').html(htmlcontent);
  oTable = $('#hardwaretable').dataTable( {
                  "sDom": '<"H"lfrC>t<"F"ip>',
                  "oTableTools": {
                    "sRowSelect": "single",
                  },
                  "aaSorting": [[ 0, "desc" ]],
                  "bSortClasses": false,
                  "bProcessing": true,
                  "bStateSave": true,
                  "bJQueryUI": true,
                  "aLengthMenu": [[25, 50, 100, -1], [25, 50, 100, "All"]],
                  "iDisplayLength" : 25,
                  "sPaginationType": "full_numbers"
                } );

	$("#hardwarecontent #hardwareparamstable #combotype").change(function() { 
		UpdateHardwareParamControls();
	});
	$("#hardwarecontent #hardwareparamsshareenabled #shareenabled").click(function() { 
		UpdateHardwareParamControls();
	});
	
	
  $('#modal').hide();
  RefreshHardwareTable();
  UpdateHardwareParamControls();
 }


$(document).ready(function() {
	//global var
	$.devIdx=0;
	$.myglobals = {
		HardwareTypesStr : [],
		SerialPortVal : [],
		SerialPortStr : [],
		SelectedHardwareIdx: 0
	};
	$('#hardwareparamstable #combotype > option').each(function() {
				 $.myglobals.HardwareTypesStr.push($(this).text());
	});
	$('#hardwareparamsserial #comboserialport > option').each(function() {
				 $.myglobals.SerialPortStr.push($(this).text());
				 $.myglobals.SerialPortVal.push(parseInt($(this).val()));
	});
  ShowHardware();
} );  
</script>