<div id="dialog-editutilitydevice" title="Edit Device">
    <form>
        <label for="name">Name: </label>
        <input type="text" id="devicename" style="width: 250px; padding: .4em;" class="text ui-widget-content ui-corner-all" />
    </form>
</div>
<div id="dialog-editmeterdevice" title="Edit Meter Device">
    <form>
        <table class="display" id="metertable" border="0" cellpadding="0" cellspacing="0">
        <tr>
          <td align="right" style="width:60px"><label for="name">Name: </label></td>
          <td><input type="text" id="devicename" style="width: 250px; padding: .4em;" class="text ui-widget-content ui-corner-all" /></td>
        </tr>
        <tr>
          <td align="right"><label for="metertype">Type: </label></td>
          <td><select id="combometertype" style="width:150px" class="combobox ui-corner-all">
            <!--#embed metertypes -->
          </select></td>
		</tr>
		</table>
    </form>
</div>
<div id="dialog-editsetpointdevice" title="Edit Meter Device">
    <form>
        <table class="display" id="metertable" border="0" cellpadding="0" cellspacing="0">
        <tr>
          <td align="right" style="width:60px"><label for="name">Name: </label></td>
          <td><input type="text" id="devicename" style="width: 250px; padding: .4em;" class="text ui-widget-content ui-corner-all" /></td>
        </tr>
		<tr>
			<td align="right"><label for="protected"><span data-i18n="Protected">Protected</span>:</label></td>
			<td><input type="checkbox" id="protected"></td>
		</tr>
        <tr>
          <td align="right"><label>Value: </label></td>
          <td><input type="text" id="setpoint" style="width: 50px; padding: .4em;" class="text ui-widget-content ui-corner-all" /> &deg; C</td>
		</tr>
		</table>
    </form>
</div>

<div id="utilitycontent">
</div>

<div id="currentlog" style="display:none;">
  <h2 data-i18n="Day">Day</h2>
  <div id="currentdaygraph" style="height: 300px;"></div>
  <br>
  <h2 data-i18n="Month">Month</h2>
  <div id="currentmonthgraph" style="height: 300px;"></div>
  <br>
  <h2 data-i18n="Year">Year</h2>
  <div id="currentyeargraph" style="height: 300px;"></div>
</div>

<div id="percentagelog" style="display:none;">
  <h2 data-i18n="Day">Day</h2>
  <div id="percentagedaygraph" style="height: 300px;"></div>
  <br>
  <h2 data-i18n="Month">Month</h2>
  <div id="percentagemonthgraph" style="height: 300px;"></div>
  <br>
  <h2 data-i18n="Year">Year</h2>
  <div id="percentageyeargraph" style="height: 300px;"></div>
</div>

<div id="fanlog" style="display:none;">
  <h2 data-i18n="Day">Day</h2>
  <div id="fandaygraph" style="height: 300px;"></div>
  <br>
  <h2 data-i18n="Month">Month</h2>
  <div id="fanmonthgraph" style="height: 300px;"></div>
  <br>
  <h2 data-i18n="Year">Year</h2>
  <div id="fanyeargraph" style="height: 300px;"></div>
</div>

<script type="text/javascript" charset="utf-8">

function MakeFavorite(id,isfavorite)
{
	if (window.my_config.userrights!=2) {
        HideNotify();
		ShowNotify($.i18n('You do not have permission to do that!'), 2500, true);
		return;
	}

	clearInterval($.myglobals.refreshTimer);
  $.ajax({
     url: "json.htm?type=command&param=makefavorite&idx=" + id + "&isfavorite=" + isfavorite, 
     async: false, 
     dataType: 'json',
     success: function(data) {
      ShowUtilities();
     }
  });
}

function EditUtilityDevice(idx,name)
{
	clearInterval($.myglobals.refreshTimer);
  $.devIdx=idx;
  $("#dialog-editutilitydevice #devicename").val(name);
  $( "#dialog-editutilitydevice" ).dialog( "open" );
}

function EditMeterDevice(idx,name,switchtype)
{
	clearInterval($.myglobals.refreshTimer);
  $.devIdx=idx;
  $("#dialog-editmeterdevice #devicename").val(name);
  $("#dialog-editmeterdevice #combometertype").val(switchtype);
  $("#dialog-editmeterdevice" ).dialog( "open" );
}

function EditSetPointInt(idx,name,setpoint,isprotected)
{
	$("#dialog-editsetpointdevice #devicename").val(name);
	$('#dialog-editsetpointdevice #protected').prop('checked',(isprotected==true));
	$("#dialog-editsetpointdevice #setpoint").val(setpoint);
	$("#dialog-editsetpointdevice" ).dialog( "open" );
}

function EditSetPoint(idx,name,setpoint,isprotected)
{
	clearInterval($.myglobals.refreshTimer);
	if (typeof isprotected != 'undefined') {
		if (isprotected==true) {
			bootbox.prompt($.i18n("Please enter Password")+":", function(result) {
				if (result === null) {
					return;
				} else {
					if (result=="") {
						return;
					}
					//verify password
					$.ajax({
						 url: "json.htm?type=command&param=verifypasscode" + 
								"&passcode=" + result,
						 async: false, 
						 dataType: 'json',
						 success: function(data) {
							if (data.status=="OK") {
								EditSetPointInt(idx,name,setpoint,isprotected)
							}
						 },
						 error: function(){
						 }
					});
				}
			});
		}
		else {
			EditSetPointInt(idx,name,setpoint,isprotected)
		}
	}
	else {
		EditSetPointInt(idx,name,setpoint,isprotected)
	}
}

function AddUtilityDevice()
{
  bootbox.alert($.i18n('Please use the devices tab for this.'));
}

function AddDataToCurrentChart(data,chart,switchtype)
{
    var datatablev1 = [];
    var datatablev2 = [];
    var datatablev3 = [];
    var datatablev4 = [];
    var datatablev5 = [];
    var datatablev6 = [];

    $.each(data.result, function(i,item)
    {
			if (chart == $.DayChart) {
       datatablev1.push( [GetUTCFromString(item.d), parseFloat(item.v1) ] );
       datatablev2.push( [GetUTCFromString(item.d), parseFloat(item.v2) ] );
       datatablev3.push( [GetUTCFromString(item.d), parseFloat(item.v3) ] );
			}
			else {
       datatablev1.push( [GetDateFromString(item.d), parseFloat(item.v1) ] );
       datatablev2.push( [GetDateFromString(item.d), parseFloat(item.v2) ] );
       datatablev3.push( [GetDateFromString(item.d), parseFloat(item.v3) ] );
       datatablev4.push( [GetDateFromString(item.d), parseFloat(item.v4) ] );
       datatablev5.push( [GetDateFromString(item.d), parseFloat(item.v5) ] );
       datatablev6.push( [GetDateFromString(item.d), parseFloat(item.v6) ] );
			}
    });

    var series;
    if (switchtype==0)
    {
			//Current (A)
			if (chart == $.DayChart) {
				if (data.haveL1) {
					chart.addSeries(
						{
							id: 'current1',
							name: 'Current_L1',
							color: 'rgba(3,190,252,0.8)',
							yAxis: 0
						}
					);
					series = chart.get('current1');
					series.setData(datatablev1);
				}
				if (data.haveL2) {
					chart.addSeries(
						{
							id: 'current2',
							name: 'Current_L2',
							color: 'rgba(252,190,3,0.8)',
							yAxis: 0
						}
					);
					series = chart.get('current2');
					series.setData(datatablev2);
				}
				if (data.haveL3) {
					chart.addSeries(
						{
							id: 'current3',
							name: 'Current_L3',
							color: 'rgba(190,252,3,0.8)',
							yAxis: 0
						}
					);
					series = chart.get('current3');
					series.setData(datatablev3);
				}
			}
			else {
				if (data.haveL1) {
					chart.addSeries(
						{
							id: 'current1min',
							name: 'Current_L1_Min',
							color: 'rgba(3,190,252,0.8)',
							yAxis: 0
						}
					);
					chart.addSeries(
						{
							id: 'current1max',
							name: 'Current_L1_Max',
							color: 'rgba(3,252,190,0.8)',
							yAxis: 0
						}
					);
					series = chart.get('current1min');
					series.setData(datatablev1);
					series = chart.get('current1max');
					series.setData(datatablev2);
				}
				if (data.haveL2) {
					chart.addSeries(
						{
							id: 'current2min',
							name: 'Current_L2_Min',
							color: 'rgba(252,190,3,0.8)',
							yAxis: 0
						}
					);
					chart.addSeries(
						{
							id: 'current2max',
							name: 'Current_L2_Max',
							color: 'rgba(252,3,190,0.8)',
							yAxis: 0
						}
					);
					series = chart.get('current2min');
					series.setData(datatablev3);
					series = chart.get('current2max');
					series.setData(datatablev4);
				}
				if (data.haveL3) {
					chart.addSeries(
						{
							id: 'current3min',
							name: 'Current_L3_Min',
							color: 'rgba(190,252,3,0.8)',
							yAxis: 0
						}
					);
					chart.addSeries(
						{
							id: 'current3max',
							name: 'Current_L3_Min',
							color: 'rgba(112,146,190,0.8)',
							yAxis: 0
						}
					);
					series = chart.get('current3min');
					series.setData(datatablev5);
					series = chart.get('current3max');
					series.setData(datatablev6);
				}
			}
			chart.yAxis[0].axisTitle.attr({
					text: 'Current (A)'
			});			
    }
    else if (switchtype==1)
    {
			//Watt
			if (chart == $.DayChart) {
				if (data.haveL1) {
					chart.addSeries(
						{
							id: 'current1',
							name: 'Usage_L1',
							color: 'rgba(3,190,252,0.8)',
							yAxis: 0
						}
					);
					series = chart.get('current1');
					series.setData(datatablev1);
				}
				if (data.haveL2) {
					chart.addSeries(
						{
							id: 'current2',
							name: 'Usage_L2',
							color: 'rgba(252,190,3,0.8)',
							yAxis: 0
						}
					);
					series = chart.get('current2');
					series.setData(datatablev2);
				}
				if (data.haveL3) {
					chart.addSeries(
						{
							id: 'current3',
							name: 'Usage_L3',
							color: 'rgba(190,252,3,0.8)',
							yAxis: 0
						}
					);
					series = chart.get('current3');
					series.setData(datatablev3);
				}
			}
			else {
				if (data.haveL1) {
					chart.addSeries(
						{
							id: 'current1min',
							name: 'Usage_L1_Min',
							color: 'rgba(3,190,252,0.8)',
							yAxis: 0
						}
					);
					chart.addSeries(
						{
							id: 'current1max',
							name: 'Usage_L1_Max',
							color: 'rgba(3,252,190,0.8)',
							yAxis: 0
						}
					);
					series = chart.get('current1min');
					series.setData(datatablev1);
					series = chart.get('current1max');
					series.setData(datatablev2);
				}
				if (data.haveL2) {
					chart.addSeries(
						{
							id: 'current2min',
							name: 'Usage_L2_Min',
							color: 'rgba(252,190,3,0.8)',
							yAxis: 0
						}
					);
					chart.addSeries(
						{
							id: 'current2max',
							name: 'Usage_L2_Max',
							color: 'rgba(252,3,190,0.8)',
							yAxis: 0
						}
					);
					series = chart.get('current2min');
					series.setData(datatablev3);
					series = chart.get('current2max');
					series.setData(datatablev4);
				}
				if (data.haveL3) {
					chart.addSeries(
						{
							id: 'current3min',
							name: 'Usage_L3_Min',
							color: 'rgba(190,252,3,0.8)',
							yAxis: 0
						}
					);
					chart.addSeries(
						{
							id: 'current3max',
							name: 'Usage_L3_Min',
							color: 'rgba(112,146,190,0.8)',
							yAxis: 0
						}
					);
					series = chart.get('current3min');
					series.setData(datatablev5);
					series = chart.get('current3max');
					series.setData(datatablev6);
				}
			}
			chart.yAxis[0].axisTitle.attr({
					text: 'Usage (Watt)'
			});			
    }
		chart.yAxis[0].redraw();
}

function ShowCurrentLog(id,name,switchtype)
{
	clearInterval($.myglobals.refreshTimer);
  $('#modal').show();
  $.devIdx=id;
  $.devName=name;
  $.devSwitchType=switchtype;
  var htmlcontent = '';
  htmlcontent='<p><center><h2>' + name + '</h2></center></p>\n';
  htmlcontent+=$('#currentlog').html();
  $('#utilitycontent').html(GetBackbuttonHTMLTable('ShowUtilities')+htmlcontent);
  $('#utilitycontent').i18n();
  
  $.DayChart = new Highcharts.Chart({
      chart: {
          renderTo: 'currentdaygraph',
          type: 'line',
          zoomType: 'xy',
          events: {
              load: function() {
                $.getJSON("json.htm?type=graph&sensor=counter&idx="+id+"&range=day",
                function(data) {
											AddDataToCurrentChart(data,$.DayChart,switchtype);
                });
              }
          }
        },
       credits: {
          enabled: true,
          href: "http://www.domoticz.com",
          text: "Domoticz.com"
        },
        title: {
            text: Get5MinuteHistoryDaysGraphTitle()
        },
        xAxis: {
            type: 'datetime'
        },
        yAxis: {
            title: {
                text: $.i18n('Usage')
            },
            min: 0
        },
        tooltip: {
            formatter: function() {
										var unit = {
																'Usage': 'Watt',
																'Current_L1': 'A',
																'Current_L2': 'A',
																'Current_L3': 'A',
																'Usage_L1': 'Watt',
																'Usage_L2': 'Watt',
																'Usage_L3': 'Watt'
													}[this.series.name];
                    return this.series.name + ':<br/>' + $.i18n(Highcharts.dateFormat('%A',this.x)) + '<br/>' + Highcharts.dateFormat('%Y-%m-%d %H:%M', this.x) +': '+ this.y + ' ' + unit;
            }
        },
        plotOptions: {
						 line: {
									lineWidth: 3,
									states: {
											hover: {
													lineWidth: 3
											}
									},
									marker: {
											enabled: false,
											states: {
													hover: {
															enabled: true,
															symbol: 'circle',
															radius: 5,
															lineWidth: 1
													}
											}
									}
							}
        },
        legend: {
            enabled: true
        }
    });
  
  $.MonthChart = new Highcharts.Chart({
      chart: {
          renderTo: 'currentmonthgraph',
          type: 'spline',
          marginRight: 10,
          zoomType: 'xy',
          events: {
              load: function() {
                  
                $.getJSON("json.htm?type=graph&sensor=counter&idx="+id+"&range=month",
                function(data) {
											AddDataToCurrentChart(data,$.MonthChart,switchtype);
                });
              }
          }
        },
       credits: {
          enabled: true,
          href: "http://www.domoticz.com",
          text: "Domoticz.com"
        },
        title: {
            text: $.i18n('Last Month')
        },
        xAxis: {
            type: 'datetime'
        },
        yAxis: {
            title: {
                text: $.i18n('Usage')
            },
            min: 0
        },
        tooltip: {
            formatter: function() {
										var unit = {
																'Usage': 'kWh',
																'Current_L1_Min': 'A',
																'Current_L1_Max': 'A',
																'Current_L2_Min': 'A',
																'Current_L2_Max': 'A',
																'Current_L3_Min': 'A',
																'Current_L3_Max': 'A',
																'Usage_L1_Min': 'Watt',
																'Usage_L1_Max': 'Watt',
																'Usage_L2_Min': 'Watt',
																'Usage_L2_Max': 'Watt',
																'Usage_L3_Min': 'Watt',
																'Usage_L3_Max': 'Watt'
													}[this.series.name];
                    return this.series.name + ':<br/>' + $.i18n(Highcharts.dateFormat('%A',this.x)) + '<br/>' + Highcharts.dateFormat('%Y-%m-%d', this.x) +': '+ this.y + ' ' + unit;
            }
        },
        plotOptions: {
			series: {
				point: {
					events: {
						click: function(event) {
							chartPointClickEx(event,ShowCurrentLog);
						}
					}
				}
			},
			spline: {
                lineWidth: 3,
                states: {
                    hover: {
                        lineWidth: 3
                    }
                },
                marker: {
                    enabled: false,
                    states: {
                        hover: {
                            enabled: true,
                            symbol: 'circle',
                            radius: 5,
                            lineWidth: 1
                        }
                    }
                }
            }
        },
        legend: {
            enabled: true
        }
    });

  $.YearChart = new Highcharts.Chart({
      chart: {
          renderTo: 'currentyeargraph',
          type: 'spline',
          marginRight: 10,
          zoomType: 'xy',
          events: {
              load: function() {
                  
                $.getJSON("json.htm?type=graph&sensor=counter&idx="+id+"&range=year",
                function(data) {
											AddDataToCurrentChart(data,$.YearChart,switchtype);
                });
              }
          }
        },
       credits: {
          enabled: true,
          href: "http://www.domoticz.com",
          text: "Domoticz.com"
        },
        title: {
            text: $.i18n('Last Year')
        },
        xAxis: {
            type: 'datetime'
        },
        yAxis: {
            title: {
                text: $.i18n('Usage')
            },
            min: 0
        },
        tooltip: {
            formatter: function() {
										var unit = {
																'Usage': 'kWh',
																'Current_L1_Min': 'A',
																'Current_L1_Max': 'A',
																'Current_L2_Min': 'A',
																'Current_L2_Max': 'A',
																'Current_L3_Min': 'A',
																'Current_L3_Max': 'A',
																'Usage_L1_Min': 'Watt',
																'Usage_L1_Max': 'Watt',
																'Usage_L2_Min': 'Watt',
																'Usage_L2_Max': 'Watt',
																'Usage_L3_Min': 'Watt',
																'Usage_L3_Max': 'Watt'
													}[this.series.name];
                    return this.series.name + ':<br/>' + $.i18n(Highcharts.dateFormat('%A',this.x)) + '<br/>' + Highcharts.dateFormat('%Y-%m-%d', this.x) +': '+ this.y + ' ' + unit;
            }
        },
        plotOptions: {
			series: {
				point: {
					events: {
						click: function(event) {
							chartPointClickEx(event,ShowCurrentLog);
						}
					}
				}
			},
			spline: {
                lineWidth: 3,
                states: {
                    hover: {
                        lineWidth: 3
                    }
                },
                marker: {
                    enabled: false,
                    states: {
                        hover: {
                            enabled: true,
                            symbol: 'circle',
                            radius: 5,
                            lineWidth: 1
                        }
                    }
                }
            }
        },
        legend: {
            enabled: true
        }
    });
}

function RefreshUtilities()
{
	clearInterval($.myglobals.refreshTimer);
  var id="";

  $.ajax({
     url: "json.htm?type=devices&filter=utility&used=true&order=Name", 
     async: false, 
     dataType: 'json',
     success: function(data) {
      if (typeof data.result != 'undefined') {
        $.each(data.result, function(i,item){
			id="#utilitycontent #" + item.idx;
			var obj=$(id);
			if (typeof obj != 'undefined') {
				if ($(id + " #name").html()!=item.Name) {
					$(id + " #name").html(item.Name);
				}
				var status="";
				var bigtext="";
				if (typeof item.Counter != 'undefined') {
					if ((item.SubType == "Gas")||(item.SubType == "RFXMeter counter")) {
						status=item.Counter;
						bigtext=item.CounterToday;
					}
					else {
						status=item.Counter + ', ' + $.i18n("Today") + ': ' + item.CounterToday;
					}
				}
				else if ((item.Type == "Current")||(item.Type == "Current/Energy")) {
				  status=item.Data;
				}
				else if (item.Type == "Energy") {
					status=item.Data;
				}
				else if (item.SubType == "Percentage") {
					status=item.Data;
					bigtext=item.Data;
				}
				else if (item.Type == "Fan") {
					status=item.Data;
					bigtext=item.Data;
				}
				else if (item.Type == "Air Quality") {
					status=item.Data + " (" + item.Quality + ")";
					bigtext=item.Data;
				}
				else if (item.SubType == "Soil Moisture") {
					status=item.Data + " (" + item.Desc + ")";
					bigtext=item.Data;
				}
				else if (item.SubType == "Leaf Wetness") {
					status=item.Data;
					bigtext=item.Data;
				}
				else if ((item.SubType == "Voltage")||(item.SubType == "A/D")) {
					status=item.Data;
					bigtext=item.Data;
				}
				else if (item.Type == "Lux") {
					status=item.Data;
					bigtext=item.Data;
				}
				else if (item.Type == "Weight") {
					status=item.Data;
					bigtext=item.Data;
				}
				else if (item.Type == "Usage") {
					status=item.Data;
					bigtext=item.Data;
				}
				else if ((item.Type == "Thermostat")&&(item.SubType=="SetPoint")) {
					status=item.Data + '\u00B0 C';
					bigtext=item.Data + '\u00B0 C';
				}
				if (typeof item.Usage != 'undefined') {
					bigtext=item.Usage;
				}
				if (typeof item.CounterDeliv != 'undefined') {
					if (item.CounterDeliv!=0) {
						status+='<br>' + $.i18n("Return") + ': ' + item.CounterDeliv + ', ' + $.i18n("Today") + ': ' + item.CounterDelivToday;
						if (item.UsageDeliv.charAt(0) != 0) {
							bigtext='-' + item.UsageDeliv;
						}
					}
				}
				
				var nbackcolor="#D4E1EE";
				if (item.Protected==true) {
					nbackcolor="#A4B1EE";
				}
				if (item.HaveTimeout==true) {
					nbackcolor="#DF2D3A";
				}
				else {
					var BatteryLevel=parseInt(item.BatteryLevel);
					if (BatteryLevel!=255) {
						if (BatteryLevel<=10) {
							nbackcolor="#DDDF2D";
						}
					}
				}
				var obackcolor=rgb2hex($(id + " #name").css( "background-color" )).toUpperCase();
				if (obackcolor!=nbackcolor) {
					$(id + " #name").css( "background-color", nbackcolor );
				}

				if ($(id + " #status").html()!=status) {
					$(id + " #bigtext").html(bigtext);
					$(id + " #status").html(status);
				}
				if ($(id + " #lastupdate").html()!=item.LastUpdate) {
					$(id + " #lastupdate").html(item.LastUpdate);
				}
			}
        });
      }
     }
  });
	RefreshTimeAndSun();
	$.myglobals.refreshTimer = setInterval(RefreshUtilities, 10000);
}

function ShowUtilities()
{
	clearInterval($.myglobals.refreshTimer);
  $('#modal').show();
  
  var htmlcontent = '';
  var bHaveAddedDevider = false;
	var bAllowWidgetReorder=true;

  var tophtm=
        '\t<table class="bannav" id="bannav" border="0" cellpadding="0" cellspacing="0" width="100%">\n' +
        '\t<tr>\n' +
		'\t  <td align="left"><div id="timesun" /></td>\n';
  if (window.my_config.userrights==2) {
	tophtm+=
        '\t  <td style="width: 150px;" align="right">\n' +
        '\t    <a class="btnstyle" onclick="AddUtilityDevice();" data-i18n="Add Sensor">Add Sensor</a>\n' +
        '\t  </td>\n';
  }
  tophtm+=
        '\t</tr>\n' +
        '\t</table>\n';
  

  var i=0;
  $.ajax({
     url: "json.htm?type=devices&filter=utility&used=true&order=Name", 
     async: false, 
     dataType: 'json',
     success: function(data) {
      if (typeof data.result != 'undefined') {

		$.FiveMinuteHistoryDays=data["5MinuteHistoryDays"];
		bAllowWidgetReorder=data.AllowWidgetOrdering;

        $.each(data.result, function(i,item){
          if (i % 3 == 0)
          {
            //add devider
            if (bHaveAddedDevider == true) {
              //close previous devider
              htmlcontent+='</div>\n';
            }
            htmlcontent+='<div class="row divider">\n';
            bHaveAddedDevider=true;
          }
          
          var xhtm=
                '\t<div class="span4" id="' + item.idx + '">\n' +
                '\t  <section>\n' +
                '\t    <table id="itemtable" border="0" cellpadding="0" cellspacing="0">\n' +
                '\t    <tr>\n';
				var nbackcolor="#D4E1EE";
				if (item.Protected==true) {
					nbackcolor="#A4B1EE";
				}
				if (item.HaveTimeout==true) {
					nbackcolor="#DF2D3A";
				}
				else {
					var BatteryLevel=parseInt(item.BatteryLevel);
					if (BatteryLevel!=255) {
						if (BatteryLevel<=10) {
							nbackcolor="#DDDF2D";
						}
					}
				}
				xhtm+='\t      <td id="name" style="background-color: ' + nbackcolor + ';">' + item.Name + '</td>\n';
				xhtm+='\t      <td id="bigtext">';
				if ((typeof item.Usage != 'undefined') && (typeof item.UsageDeliv == 'undefined')) {
					xhtm+=item.Usage;
				}
				else if ((typeof item.Usage != 'undefined') && (typeof item.UsageDeliv != 'undefined')) {
					if ((item.UsageDeliv.charAt(0) == 0)||(parseInt(item.Usage)!=0)) {
						xhtm+=item.Usage;
					}
					if (item.UsageDeliv.charAt(0) != 0) {
						xhtm+='-' + item.UsageDeliv;
					}
				}
				else if ((item.SubType == "Gas")||(item.SubType == "RFXMeter counter")) {
				  xhtm+=item.CounterToday;
				}
				else if (item.Type == "Air Quality") {
				  xhtm+=item.Data;
				}
				else if (item.SubType == "Percentage") {
				  xhtm+=item.Data;
				}
				else if (item.Type == "Fan") {
				  xhtm+=item.Data;
				}
				else if (item.SubType == "Soil Moisture") {
				  xhtm+=item.Data;
				}
				else if (item.SubType == "Leaf Wetness") {
				  xhtm+=item.Data;
				}
				else if ((item.SubType == "Voltage")||(item.SubType == "A/D")) {
				  xhtm+=item.Data;
				}
				else if (item.Type == "Lux") {
				  xhtm+=item.Data;
				}
				else if (item.Type == "Weight") {
				  xhtm+=item.Data;
				}
				else if (item.Type == "Usage") {
				  xhtm+=item.Data;
				}
				else if (item.Type == "Thermostat") {
				  xhtm+=item.Data + '\u00B0 C';
				}
				xhtm+='</td>\n';
          xhtm+='\t      <td id="img"><img src="images/';
            var status="";
            if (typeof item.Counter != 'undefined') {
              xhtm+='counter.png" height="48"></td>\n';
              if ((item.SubType == "Gas")||(item.SubType == "RFXMeter counter")) {
				status=item.Counter;
              }
              else {
				status=item.Counter + ', ' + $.i18n("Today") + ': ' + item.CounterToday;
              }
            }
            else if ((item.Type == "Current")||(item.Type == "Current/Energy")) {
              xhtm+='current48.png" height="48"></td>\n';
              status=item.Data;
            }
            else if (item.Type == "Energy") {
              xhtm+='current48.png" height="48"></td>\n';
              status=item.Data;
            }
            else if (item.Type == "Air Quality") {
              xhtm+='air48.png" height="48"></td>\n';
              status=item.Data + " (" + item.Quality + ")";
            }
            else if (item.SubType == "Soil Moisture") {
              xhtm+='moisture48.png" height="48"></td>\n';
              status=item.Data + " (" + item.Desc + ")";
            }
            else if (item.SubType == "Percentage") {
              xhtm+='Percentage48.png" height="48"></td>\n';
              status=item.Data;
            }
            else if (item.SubType == "System fan") {
              xhtm+='Fan48_On.png" height="48"></td>\n';
              status=item.Data;
            }
			else if (item.SubType == "Leaf Wetness") {
              xhtm+='leaf48.png" height="48"></td>\n';
              status=item.Data;
            }
            else if ((item.SubType == "Voltage")||(item.SubType == "A/D")) {
              xhtm+='current48.png" height="48"></td>\n';
              status=item.Data;
            }
            else if (item.Type == "Lux") {
              xhtm+='lux48.png" height="48"></td>\n';
              status=item.Data;
            }
            else if (item.Type == "Weight") {
              xhtm+='scale48.png" height="48"></td>\n';
              status=item.Data;
            }
            else if (item.Type == "Usage") {
              xhtm+='current48.png" height="48"></td>\n';
              status=item.Data;
            }
            else if ((item.Type == "Thermostat")&&(item.SubType=="SetPoint")) {
              xhtm+='override.png" height="48"></td>\n';
              status=item.Data + '\u00B0 C';
            }
            if (typeof item.CounterDeliv != 'undefined') {
				if (item.CounterDeliv!=0) {
					status+='<br>' + $.i18n("Return") + ': ' + item.CounterDeliv + ', ' + $.i18n("Today") + ': ' + item.CounterDelivToday;
				}
            }
            
						xhtm+=      
                '\t      <td id="status">' + status + '</td>\n' +
                '\t      <td id="lastupdate">' + item.LastUpdate + '</td>\n' +
                '\t      <td id="type">' + item.Type + ', ' + item.SubType + '</td>\n' +
                '\t      <td>';
          if (item.Favorite == 0) {
            xhtm+=      
                  '<img src="images/nofavorite.png" title="' + $.i18n('Add to Dashboard') +'" onclick="MakeFavorite(' + item.idx + ',1);" onmouseover="cursorhand()" onmouseout="cursordefault()">&nbsp;&nbsp;&nbsp;&nbsp;';
          }
          else {
            xhtm+=      
                  '<img src="images/favorite.png" title="' + $.i18n('Remove from Dashboard') +'" onclick="MakeFavorite(' + item.idx + ',0);" onmouseover="cursorhand()" onmouseout="cursordefault()">&nbsp;&nbsp;&nbsp;&nbsp;';
          }

          if (typeof item.Counter != 'undefined') {
			if ((item.Type == "P1 Smart Meter")&&(item.SubType=="Energy")) {
				xhtm+='<a class="btnsmall" onclick="ShowSmartLog(\'#utilitycontent\',\'ShowUtilities\',' + item.idx + ',\'' + item.Name + '\', ' + item.SwitchTypeVal + ');" data-i18n="Log">Log</a> ';
			}
			else {
				xhtm+='<a class="btnsmall" onclick="ShowCounterLog(\'#utilitycontent\',\'ShowUtilities\',' + item.idx + ',\'' + item.Name + '\', ' + item.SwitchTypeVal + ');" data-i18n="Log">Log</a> ';
			}
			if (window.my_config.userrights==2) {
				if (item.Type == "P1 Smart Meter") {
					xhtm+='<a class="btnsmall" onclick="EditUtilityDevice(' + item.idx + ',\'' + item.Name + '\');" data-i18n="Edit">Edit</a> ';
				}
				else {
					xhtm+='<a class="btnsmall" onclick="EditMeterDevice(' + item.idx + ',\'' + item.Name + '\', ' + item.SwitchTypeVal +');" data-i18n="Edit">Edit</a> ';
				}
			}
          }
		  else if (item.Type == "Air Quality") {
			xhtm+='<a class="btnsmall" onclick="ShowAirQualityLog(\'#utilitycontent\',\'ShowUtilities\',' + item.idx + ',\'' + item.Name + '\');" data-i18n="Log">Log</a> ';
			if (window.my_config.userrights==2) {
				xhtm+='<a class="btnsmall" onclick="EditUtilityDevice(' + item.idx + ',\'' + item.Name + '\');" data-i18n="Edit">Edit</a> ';
			}
		  }
		  else if (item.SubType == "Percentage") {
			xhtm+='<a class="btnsmall" onclick="ShowPercentageLog(\'#utilitycontent\',\'ShowUtilities\',' + item.idx + ',\'' + item.Name + '\');" data-i18n="Log">Log</a> ';
			if (window.my_config.userrights==2) {
				xhtm+='<a class="btnsmall" onclick="EditUtilityDevice(' + item.idx + ',\'' + item.Name + '\');" data-i18n="Edit">Edit</a> ';
			}
		  }
		  else if (item.Type == "Fan") {
			xhtm+='<a class="btnsmall" onclick="ShowFanLog(\'#utilitycontent\',\'ShowUtilities\',' + item.idx + ',\'' + item.Name + '\');" data-i18n="Log">Log</a> ';
			if (window.my_config.userrights==2) {
				xhtm+='<a class="btnsmall" onclick="EditUtilityDevice(' + item.idx + ',\'' + item.Name + '\');" data-i18n="Edit">Edit</a> ';
			}
		  }
		  else if ((item.SubType == "Soil Moisture")||(item.SubType == "Leaf Wetness")) {
			xhtm+='<a class="btnsmall" onclick="ShowGeneralGraph(\'#utilitycontent\',\'ShowUtilities\',' + item.idx + ',\'' + item.Name+ '\',' + item.SwitchTypeVal +', \'' + item.SubType + '\');" data-i18n="Log">Log</a> ';
			if (window.my_config.userrights==2) {
				xhtm+='<a class="btnsmall" onclick="EditUtilityDevice(' + item.idx + ',\'' + item.Name + '\');" data-i18n="Edit">Edit</a> ';
			}
		  }
		  else if (item.Type == "Lux") {
			xhtm+='<a class="btnsmall" onclick="ShowLuxLog(\'#utilitycontent\',\'ShowUtilities\',' + item.idx + ',\'' + item.Name + '\');" data-i18n="Log">Log</a> ';
			if (window.my_config.userrights==2) {
				xhtm+='<a class="btnsmall" onclick="EditUtilityDevice(' + item.idx + ',\'' + item.Name + '\');" data-i18n="Edit">Edit</a> ';
			}
		  }
		  else if (item.Type == "Weight") {
			xhtm+='<a class="btnsmall" onclick="ShowGeneralGraph(\'#utilitycontent\',\'ShowUtilities\',' + item.idx + ',\'' + item.Name+ '\',\'' + item.Type +'\', \'' + item.SubType + '\');" data-i18n="Log">Log</a> ';
			if (window.my_config.userrights==2) {
				xhtm+='<a class="btnsmall" onclick="EditUtilityDevice(' + item.idx + ',\'' + item.Name + '\');" data-i18n="Edit">Edit</a> ';
			}
		  }
		  else if (item.Type == "Usage") {
			xhtm+='<a class="btnsmall" onclick="ShowUsageLog(\'#utilitycontent\',\'ShowUtilities\',' + item.idx + ',\'' + item.Name + '\');" data-i18n="Log">Log</a> ';
			if (window.my_config.userrights==2) {
				xhtm+='<a class="btnsmall" onclick="EditUtilityDevice(' + item.idx + ',\'' + item.Name + '\');" data-i18n="Edit">Edit</a> ';
			}
		  }
          else if ((item.Type == "Current")||(item.Type == "Current/Energy")) {
			xhtm+='<a class="btnsmall" onclick="ShowCurrentLog(' + item.idx + ',\'' + item.Name + '\', ' + item.displaytype + ');" data-i18n="Log">Log</a> ';
			if (window.my_config.userrights==2) {
				xhtm+='<a class="btnsmall" onclick="EditUtilityDevice(' + item.idx + ',\'' + item.Name + '\');" data-i18n="Edit">Edit</a> ';
			}
          }
          else if (item.Type == "Energy") {
				xhtm+='<a class="btnsmall" onclick="ShowCounterLogSpline(\'#utilitycontent\',\'ShowUtilities\',' + item.idx + ',\'' + item.Name + '\', ' + item.SwitchTypeVal + ');" data-i18n="Log">Log</a> ';
				if (window.my_config.userrights==2) {
					xhtm+='<a class="btnsmall" onclick="EditUtilityDevice(' + item.idx + ',\'' + item.Name + '\');" data-i18n="Edit">Edit</a> ';
				}
          }
          else if ((item.Type == "Thermostat")&&(item.SubType=="SetPoint")) {
				if (window.my_config.userrights==2) {
					xhtm+='<a class="btnsmall" onclick="ShowTempLog(\'#utilitycontent\',\'ShowUtilities\',' + item.idx + ',\'' + item.Name + '\');" data-i18n="Log">Log</a> ';
					xhtm+='<a class="btnsmall" onclick="EditSetPoint(' + item.idx + ',\'' + item.Name + '\', ' + item.SetPoint + ',' + item.Protected +');" data-i18n="Edit">Edit</a> ';
				}
          }
          else if ((item.Type == "General")&&(item.SubType == "Voltage")) {
			xhtm+='<a class="btnsmall" onclick="ShowGeneralGraph(\'#utilitycontent\',\'ShowUtilities\',' + item.idx + ',\'' + item.Name+ '\',' + item.SwitchTypeVal +', \'VoltageGeneral\');" data-i18n="Log">Log</a> ';
			if (window.my_config.userrights==2) {
				xhtm+='<a class="btnsmall" onclick="EditUtilityDevice(' + item.idx + ',\'' + item.Name + '\');" data-i18n="Edit">Edit</a> ';
			}
          }
		  else if ((item.SubType == "Voltage")||(item.SubType == "A/D")) {
			xhtm+='<a class="btnsmall" onclick="ShowGeneralGraph(\'#utilitycontent\',\'ShowUtilities\',' + item.idx + ',\'' + item.Name+ '\',' + item.SwitchTypeVal +', \'' + item.SubType + '\');" data-i18n="Log">Log</a> ';
			if (window.my_config.userrights==2) {
				xhtm+='<a class="btnsmall" onclick="EditUtilityDevice(' + item.idx + ',\'' + item.Name + '\');" data-i18n="Edit">Edit</a> ';
			}
		  }
          else {
			if (window.my_config.userrights==2) {
				xhtm+='<a class="btnsmall" onclick="EditUtilityDevice(' + item.idx + ',\'' + item.Name + '\');" data-i18n="Edit">Edit</a> ';
			}
		  }
		  if (window.my_config.userrights==2) {              
			  if (item.Notifications == "true")
				xhtm+='<a class="btnsmall-sel" onclick="ShowNotifications(' + item.idx + ',\'' + item.Name + '\', \'#utilitycontent\', \'ShowUtilities\');" data-i18n="Notifications">Notifications</a>';
			  else
				xhtm+='<a class="btnsmall" onclick="ShowNotifications(' + item.idx + ',\'' + item.Name + '\', \'#utilitycontent\', \'ShowUtilities\');" data-i18n="Notifications">Notifications</a>';
		  }
          xhtm+=      
                '</td>\n' +
                '\t    </tr>\n' +
                '\t    </table>\n' +
                '\t  </section>\n' +
                '\t</div>\n';
          htmlcontent+=xhtm;
        });
      }
     }
  });
  if (bHaveAddedDevider == true) {
    //close previous devider
    htmlcontent+='</div>\n';
  }
  if (htmlcontent == '')
  {
    htmlcontent='<h2>' + $.i18n('No Utility sensors found or added in the system...') + '</h2>';
  }
  $('#modal').hide();
  $('#utilitycontent').html(tophtm+htmlcontent);
  $('#utilitycontent').i18n();

	if (bAllowWidgetReorder==true) {
		if (window.my_config.userrights==2) {
			if (window.myglobals.ismobileint==false) {
				$("#utilitycontent .span4").draggable({
						drag: function() {
							clearInterval($.myglobals.refreshTimer);
							$.devIdx=$(this).attr("id");
							$(this).css("z-index", 2);
						},
						revert: true
				});
				$("#utilitycontent .span4").droppable({
						drop: function() {
							var myid=$(this).attr("id");
							$.devIdx.split(' ');
							$.ajax({
								 url: "json.htm?type=command&param=switchdeviceorder&idx1=" + myid + "&idx2=" + $.devIdx,
								 async: false, 
								 dataType: 'json',
								 success: function(data) {
										ShowUtilities();
								 }
							});
						}
				});
			}
		}
	}
	RefreshTimeAndSun();
	$.myglobals.refreshTimer = setInterval(RefreshUtilities, 10000);
  return false;
}

$(document).ready(function() {
    //global var
    $.devIdx=0;
    
    $( "#dialog-editutilitydevice" ).dialog({
          autoOpen: false,
          width: 450,
          height: 160,
          modal: true,
          resizable: false,
          buttons: {
              "Update": function() {
                  var bValid = true;
                  bValid = bValid && checkLength( $("#dialog-editutilitydevice #devicename"), 2, 100 );
                  if ( bValid ) {
                      $( this ).dialog( "close" );
                      $.ajax({
                         url: "json.htm?type=setused&idx=" + $.devIdx + '&name=' + encodeURIComponent($("#dialog-editutilitydevice #devicename").val()) + '&used=true',
                         async: false, 
                         dataType: 'json',
                         success: function(data) {
                            ShowUtilities();
                         }
                      });
                      
                  }
              },
              "Remove Device": function() {
                $( this ).dialog( "close" );
				bootbox.confirm($.i18n("Are you sure to remove this Device?"), function(result) {
					if (result==true) {
                      $.ajax({
                         url: "json.htm?type=setused&idx=" + $.devIdx + '&name=' + encodeURIComponent($("#dialog-editutilitydevice #devicename").val()) + '&used=false',
                         async: false, 
                         dataType: 'json',
                         success: function(data) {
                            ShowUtilities();
                         }
                      });
					}
				});
              },
              "Transfer": function() {
                  $( this ).dialog( "close" );
                  TransferDevice($.devIdx,ShowUtilities);
              },
              Cancel: function() {
                  $( this ).dialog( "close" );
              }
          },
          close: function() {
            $( this ).dialog( "close" );
          }
    });
    $( "#dialog-editmeterdevice" ).dialog({
          autoOpen: false,
          width: 370,
          height: 200,
          modal: true,
          resizable: false,
          buttons: {
              "Update": function() {
                  var bValid = true;
                  bValid = bValid && checkLength( $("#dialog-editmeterdevice #devicename"), 2, 100 );
                  if ( bValid ) {
                      $( this ).dialog( "close" );
                      $.ajax({
                         url: "json.htm?type=setused&idx=" + $.devIdx + '&name=' + encodeURIComponent($("#dialog-editmeterdevice #devicename").val()) + '&switchtype=' + $("#dialog-editmeterdevice #combometertype").val() + '&used=true',
                         async: false, 
                         dataType: 'json',
                         success: function(data) {
                            ShowUtilities();
                         }
                      });
                      
                  }
              },
              "Remove Device": function() {
                $( this ).dialog( "close" );
				bootbox.confirm($.i18n("Are you sure to remove this Device?"), function(result) {
					if (result==true) {
                      $.ajax({
                         url: "json.htm?type=setused&idx=" + $.devIdx + '&name=' + encodeURIComponent($("#dialog-editmeterdevice #devicename").val()) + '&used=false',
                         async: false, 
                         dataType: 'json',
                         success: function(data) {
                            ShowUtilities();
                         }
                      });
					}
				});
              },
              Cancel: function() {
                  $( this ).dialog( "close" );
              }
          },
          close: function() {
            $( this ).dialog( "close" );
          }
    });

    $( "#dialog-editsetpointdevice" ).dialog({
          autoOpen: false,
          width: 390,
          height: 250,
          modal: true,
          resizable: false,
          buttons: {
              "Update": function() {
                  var bValid = true;
                  bValid = bValid && checkLength( $("#dialog-editsetpointdevice #devicename"), 2, 100 );
                  if ( bValid ) {
                      $( this ).dialog( "close" );
                      $.ajax({
                         url: "json.htm?type=setused&idx=" + $.devIdx +
                         '&name=' + encodeURIComponent($("#dialog-editsetpointdevice #devicename").val()) +
                         '&setpoint=' + $("#dialog-editsetpointdevice #setpoint").val() + 
                         '&protected=' + $('#dialog-editsetpointdevice #protected').is(":checked") +
                         '&used=true',
                         async: false, 
                         dataType: 'json',
                         success: function(data) {
                            ShowUtilities();
                         }
                      });
                      
                  }
              },
              "Remove Device": function() {
                $( this ).dialog( "close" );
				bootbox.confirm($.i18n("Are you sure to remove this Device?"), function(result) {
					if (result==true) {
                      $.ajax({
                         url: "json.htm?type=setused&idx=" + $.devIdx + '&name=' + encodeURIComponent($("#dialog-editsetpointdevice #devicename").val()) + '&used=false',
                         async: false, 
                         dataType: 'json',
                         success: function(data) {
                            ShowUtilities();
                         }
                      });
					}
				});
              },
              Cancel: function() {
                  $( this ).dialog( "close" );
              }
          },
          close: function() {
            $( this ).dialog( "close" );
          }
    });

  ShowUtilities();

	$( "#dialog-editutilitydevice" ).keydown(function (event) {
        if (event.keyCode == 13) {
			$(this).siblings('.ui-dialog-buttonpane').find('button:eq(0)').trigger("click");
            return false;
        }
    });
} );  
</script>
